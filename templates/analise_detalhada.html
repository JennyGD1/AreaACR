<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ”¬ AnÃ¡lise AvanÃ§ada de Descontos</title>
    <link rel="icon" href="{{ url_for('static', filename='img/logo_maida.png') }}" />
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/navbar.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/analise.css') }}">
</head>
<body class="page-analise">
    {% include 'components/_preloader.html' %}
    {% include 'components/_navbar.html' %}

    <div class="scrollbar-container">
        <div class="scrollbar-thumb" id="scrollThumb"></div>
    </div>
    
    <div class="container">
        <h1>ðŸ”¬ AnÃ¡lise AvanÃ§ada</h1>
        <p>Tabela detalhada de descontos por competÃªncia, com base nos arquivos enviados.</p>
        
        {% if dados_analisados %}
            {# --- LÃ³gica para preparar os dados da tabela --- #}
            {% set todas_competencias = [] %}
            {% set colunas_ativas = {} %}

            {% for ano, dados_ano in dados_analisados.items() %}
                {% for mes, dados_mes in dados_ano.detalhes_mensais.items() %}
                    {% set comp_dict = {'competencia': mes} %}
                    {% do comp_dict.update(dados_mes.valores) %}
                    {% do todas_competencias.append(comp_dict) %}
                    {% for chave in dados_mes.valores.keys() %}
                        {% if dados_mes.valores[chave] > 0 %}
                            {% do colunas_ativas.update({chave: True}) %}
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            {% endfor %}

            {% set ordem_desejada = ["titular", "parcela_risco_titular", "conjuge", "parcela_risco_conjuge", "dependente", "parcela_risco_dependente", "agregado_jovem", "parcela_risco_agregado", "agregado_maior", "plano_especial", "coparticipacao", "retroativo"] %}
            {% set colunas_ordenadas = [] %}
            {% for chave in ordem_desejada %}
                {% if colunas_ativas.get(chave) %}
                    {% do colunas_ordenadas.append(chave) %}
                {% endif %}
            {% endfor %}
            
            <div class="tabela-container">
                <table class="tabela-analise">
                    <thead>
                        <tr>
                            <th>MÃªs/Ano</th>
                            {% for chave in colunas_ordenadas %}
                                <th>{{ descricao_rubricas.get(chave, chave|replace('_', ' ')|title) }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for comp in todas_competencias|sort(attribute='competencia') %}
                        <tr>
                            <td>{{ comp.competencia.replace('Janeiro', '01').replace('Fevereiro', '02').replace('MarÃ§o', '03').replace('Abril', '04').replace('Maio', '05').replace('Junho', '06').replace('Julho', '07').replace('Agosto', '08').replace('Setembro', '09').replace('Outubro', '10').replace('Novembro', '11').replace('Dezembro', '12') }}</td>
                            {% for chave in colunas_ordenadas %}
                                <td>{{ "R$ %.2f"|format(comp.get(chave, 0)) }}</td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

        {% else %}
            <p>Nenhuma anÃ¡lise disponÃ­vel. Processe os arquivos primeiro.</p>
        {% endif %}

        <div class="btn-container">
            <a href="{{ url_for('mostrar_resultados') }}" class="btn btn-secondary">
                ðŸ“Š Voltar ao Resumo
            </a>
        </div>
    </div>
    
    {% include 'components/_footer.html' %}
    <script src="{{ url_for('static', filename='js/main.js') }}" defer></script>
</body>
</html>
