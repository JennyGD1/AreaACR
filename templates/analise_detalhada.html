<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî¨ An√°lise Avan√ßada de Contracheques</title>
    <link rel="icon" href="{{ url_for('static', filename='img/logo_maida.png') }}" />
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/navbar.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/analise.css') }}">
</head>
<body class="page-analise">
    {% include 'components/_preloader.html' %}
    {% include 'components/_navbar.html' %}

    <div class="scrollbar-container">
        <div class="scrollbar-thumb" id="scrollThumb"></div>
    </div>
    
    <div class="container">
        <h1>üî¨ An√°lise Avan√ßada de Contracheques</h1>
        <p>Cole o texto bruto de m√∫ltiplos contracheques (extra√≠dos do PDF) na caixa abaixo e clique em "Analisar Texto" para habilitar as op√ß√µes de relat√≥rio.</p>

        <textarea id="inputText" placeholder="Cole aqui o texto bruto dos contracheques..."></textarea>
        <button id="analisarBtn" class="btn btn-primary">Analisar Texto</button>

        <div id="painelControle" class="hidden">
            <h2>Relat√≥rios Dispon√≠veis</h2>
            <div class="filtros-container">
                <div class="filtro-item">
                    <label for="filtroAno">Filtrar por Ano:</label>
                    <select id="filtroAno">
                        <!-- O JavaScript ir√° preencher as op√ß√µes aqui -->
                    </select>
                </div>
                <div class="filtro-item">
                    <label for="filtroDesconto">Filtrar por Desconto:</label>
                    <select id="filtroDesconto">
                        <!-- O JavaScript ir√° preencher as op√ß√µes aqui -->
                    </select>
                </div>
            </div>
            <div class="btn-container">
                <button id="btnGerarTabelaGeral" class="btn btn-success">Gerar Relat√≥rio de Descontos</button>
            </div>
        </div>
        
        <div id="resultadoContainer">
            <!-- As tabelas geradas aparecer√£o aqui -->
        </div>
    </div>
    
    {% include 'components/_footer.html' %}

    <script src="{{ url_for('static', filename='js/main.js') }}" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ELEMENTOS DO DOM
            const analisarBtn = document.getElementById('analisarBtn');
            const painelControle = document.getElementById('painelControle');
            const resultadoContainer = document.getElementById('resultadoContainer');
            const filtroAno = document.getElementById('filtroAno');
            const filtroDesconto = document.getElementById('filtroDesconto');
            const btnGerarTabelaGeral = document.getElementById('btnGerarTabelaGeral');

            // ESTADO DA APLICA√á√ÉO
            let dadosProcessados = {};

            // DADOS DE REFER√äNCIA
            const mesesMap = { "Janeiro": 1, "Fevereiro": 2, "Mar√ßo": 3, "Abril": 4, "Maio": 5, "Junho": 6, "Julho": 7, "Agosto": 8, "Setembro": 9, "Outubro": 10, "Novembro": 11, "Dezembro": 12 };
            const descontosConfig = {
                'titular': { codigo: '7033', nome: 'Titular' }, 'parcela_risco_titular': { codigo: '7088', nome: 'P. Risco Titular' }, 'conjuge': { codigo: '7035', nome: 'C√¥njuge' }, 'parcela_risco_conjuge': { codigo: '7090', nome: 'P. Risco C√¥njuge' }, 'dependente': { codigo: '7034', nome: 'Dependente' }, 'parcela_risco_dependente': { codigo: '7089', nome: 'P. Risco Dependente' }, 'agregado_jovem': { codigo: '7038', nome: 'Agr. Jovem' }, 'agregado_maior': { codigo: '7039', nome: 'Agr. Maior' }, 'parcela_risco_agregado': { codigo: '7091', nome: 'P. Risco Agregado' }, 'plano_especial': { codigo: '7037', nome: 'P. Especial' }, 'coparticipacao': { codigo: '7040', nome: 'Coparticipa√ß√£o' }, 'retroativo': { codigo: '7049', nome: 'Retroativo' }, 'restituicao': { codigo: '7044', nome: 'Restitui√ß√£o' }
            };
            const descontosOrdem = ["titular", "parcela_risco_titular", "conjuge", "parcela_risco_conjuge", "dependente", "parcela_risco_dependente", "agregado_jovem", "agregado_maior", "parcela_risco_agregado", "plano_especial", "coparticipacao", "retroativo", "restituicao"];

            // --- FUN√á√ïES AUXILIARES ---
            function formatarNumero(valor) {
                // CORRE√á√ÉO: Formata como n√∫mero com duas casas decimais, usando v√≠rgula
                return (valor || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }
            
            function extrairValor(linha) {
                const valorMatch = linha.match(/(\d{1,3}(?:[\.\s]?\d{3})*,\d{2})/);
                return valorMatch ? parseFloat(valorMatch[1].replace(/\./g, '').replace(',', '.')) : 0;
            }

            // --- FUN√á√ÉO PRINCIPAL DE AN√ÅLISE ---
            function processarTextoBruto(texto) {
                const dados = {};
                const mesesRegex = new RegExp(`(${Object.keys(mesesMap).join('|')})/(\\d{4})`, 'gs');
                const blocos = texto.split(mesesRegex);

                for (let i = 1; i < blocos.length; i += 3) {
                    const mes = blocos[i];
                    const ano = blocos[i + 1];
                    const competencia = `${mes}/${ano}`;
                    const conteudo = blocos[i + 2] || "";
                    
                    if (!dados[ano]) dados[ano] = {};
                    dados[ano][competencia] = { descontos: {} };

                    const linhas = conteudo.split('\n');
                    linhas.forEach(linha => {
                        const rubricaMatch = linha.match(/^\/?\s*([A-Z0-9]{4})\b/);
                         if (rubricaMatch) {
                            const codigo = rubricaMatch[1];
                            const valor = extrairValor(linha);
                            if (valor > 0) {
                                for (const [chave, config] of Object.entries(descontosConfig)) {
                                    if (config.codigo === codigo) {
                                        dados[ano][competencia].descontos[chave] = (dados[ano][competencia].descontos[chave] || 0) + valor;
                                    }
                                }
                            }
                        }
                    });
                }
                return dados;
            }

            // --- FUN√á√ïES DE GERA√á√ÉO DE INTERFACE ---
            function popularFiltros(dados) {
                // Popula filtro de Ano
                filtroAno.innerHTML = '<option value="todos">Todos os Anos</option>';
                const anos = Object.keys(dados).sort((a, b) => b - a);
                anos.forEach(ano => {
                    filtroAno.add(new Option(ano, ano));
                });
                
                // Popula filtro de Desconto
                filtroDesconto.innerHTML = '<option value="todos">Todos os Descontos</option>';
                let todasColunas = new Set();
                Object.values(dados).forEach(anoData => {
                    Object.values(anoData).forEach(mesData => {
                        Object.keys(mesData.descontos).forEach(chave => todasColunas.add(chave));
                    });
                });

                descontosOrdem.forEach(chave => {
                    if (todasColunas.has(chave)) {
                        filtroDesconto.add(new Option(descontosConfig[chave].nome, chave));
                    }
                });
            }

            function gerarTabelaGeral() {
                const anoSelecionado = filtroAno.value;
                const descontoSelecionado = filtroDesconto.value;
                resultadoContainer.innerHTML = '';

                let todasCompetencias = [];
                Object.entries(dadosProcessados).forEach(([ano, dadosDoAno]) => {
                    if (anoSelecionado === 'todos' || ano === anoSelecionado) {
                        Object.entries(dadosDoAno).forEach(([competencia, dadosMes]) => {
                            todasCompetencias.push({ competencia, ...dadosMes });
                        });
                    }
                });
                
                if (todasCompetencias.length === 0) {
                    resultadoContainer.innerHTML = '<p class="aviso">Nenhum dado encontrado para o filtro selecionado.</p>';
                    return;
                }
                
                let colunasParaExibir;
                if (descontoSelecionado === 'todos') {
                    const colunasAtivas = new Set();
                    todasCompetencias.forEach(comp => Object.keys(comp.descontos).forEach(key => colunasAtivas.add(key)));
                    colunasParaExibir = descontosOrdem.filter(chave => colunasAtivas.has(chave));
                } else {
                    colunasParaExibir = [descontoSelecionado];
                }

                if (colunasParaExibir.length === 0) {
                    resultadoContainer.innerHTML = `<p class="aviso">Nenhum valor encontrado para o desconto selecionado no per√≠odo.</p>`;
                    return;
                }

                const tabela = document.createElement('table');
                tabela.className = 'tabela-analise';
                let headerHtml = '<thead><tr><th>M√™s/Ano</th>';
                colunasParaExibir.forEach(chave => headerHtml += `<th>${descontosConfig[chave].nome}</th>`);
                headerHtml += '</tr></thead>';
                tabela.innerHTML = headerHtml;

                const tbody = document.createElement('tbody');
                todasCompetencias.sort((a, b) => {
                    const [mesA, anoA] = a.competencia.split('/');
                    const [mesB, anoB] = b.competencia.split('/');
                    return (parseInt(anoA) * 100 + mesesMap[mesA]) - (parseInt(anoB) * 100 + mesesMap[mesB]);
                });
                
                todasCompetencias.forEach(comp => {
                    const row = tbody.insertRow();
                    const [mesNome, ano] = comp.competencia.split('/');
                    row.insertCell(0).textContent = `${mesesMap[mesNome]}/${ano}`;
                    colunasParaExibir.forEach(chave => {
                        row.insertCell(-1).textContent = formatarNumero(comp.descontos[chave] || 0);
                    });
                });
                
                tabela.appendChild(tbody);
                resultadoContainer.appendChild(tabela);
            }

            // --- EVENT LISTENERS ---
            analisarBtn.addEventListener('click', () => {
                const texto = document.getElementById('inputText').value;
                if (!texto) {
                    alert("Por favor, cole o texto dos contracheques.");
                    return;
                }
                dadosProcessados = processarTextoBruto(texto);
                
                if (dadosProcessados && Object.keys(dadosProcessados).length > 0) {
                    popularFiltros(dadosProcessados);
                    painelControle.classList.remove('hidden');
                    gerarTabelaGeral(); // Gera a tabela geral por padr√£o
                } else {
                    painelControle.classList.add('hidden');
                    resultadoContainer.innerHTML = '<p class="aviso-erro">Nenhum contracheque v√°lido ou per√≠odo (M√™s/Ano) foi encontrado no texto. Verifique o texto copiado.</p>';
                }
            });

            btnGerarTabelaGeral.addEventListener('click', gerarTabelaGeral);
            btnGerarProventos.addEventListener('click', () => {
                // A l√≥gica para proventos pode ser adicionada aqui se necess√°rio
                alert('A gera√ß√£o da tabela de proventos ainda ser√° implementada.');
            });
            
            // Adiciona listeners para os filtros atualizarem a tabela
            filtroAno.addEventListener('change', gerarTabelaGeral);
            filtroDesconto.addEventListener('change', gerarTabelaGeral);
        });
    </script>
</body>
</html>
