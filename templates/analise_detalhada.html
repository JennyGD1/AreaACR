{% extends "base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/analise.css') }}?v=1.0">
{% endblock %}

{% block content %}
<div class="container">
    <h1>Análise Detalhada</h1>
    
    {% if resultados %}
    <div class="filtros-container mb-4">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-primary active" data-tipo="descontos-geral">Descontos Detalhados</button>
            <button type="button" class="btn btn-secondary" data-tipo="proventos-geral">Proventos por Mês</button>
            <button type="button" class="btn btn-secondary" data-tipo="planserv-totais">Totais Planserv</button> {# Novo botão para os totais Planserv #}
        </div>
    </div>

    {# TABELA GERAL: PROVENTOS E DESCONTOS (DETALHADA POR RUBRICA) #}
    {# Esta tabela agora exibirá todas as rubricas que apareceram no contracheque processado #}
    {# Os valores já estarão classificados como provento (positivo) ou desconto (negativo) na source #}
    <div id="tabela-descontos-geral" class="tabela-container"> {# ID ajustado para corresponder ao novo botão #}
        <h3>Detalhes de Rubricas por Mês (Proventos e Descontos)</h3>
        {% if resultados.tabela_geral %} {# Verifica se tabela_geral existe #}
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>MÊS/ANO</th>
                    {% for coluna in resultados.tabela_geral.colunas[1:] %} {# Acessa 'tabela_geral' #}
                    <th>{{ coluna }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for linha in resultados.tabela_geral.dados %} {# Acessa 'tabela_geral' #}
                <tr>
                    <td>{{ linha.mes_ano }}</td>
                    {% for valor in linha.valores %}
                    <td>R$ {{ "%.2f"|format(valor)|replace(".", ",") }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>Não foi possível gerar a tabela detalhada de rubricas.</p>
        {% endif %}
    </div>

    {# TABELA SIMPLIFICADA DE PROVENTOS TOTAIS POR MÊS #}
    {# Esta tabela exibe apenas o total de proventos por mês, como estava antes #}
    <div id="tabela-proventos-geral" class="tabela-container" style="display: none;"> {# ID ajustado #}
        <h3>Proventos Totais por Mês</h3>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>MÊS/ANO</th>
                    <th>Total de Proventos</th>
                </tr>
            </thead>
            <tbody>
                {% for mes_ano, dados in resultados.dados_mensais.items() %}
                <tr>
                    <td>{{ mes_ano }}</td>
                    <td>R$ {{ "%.2f"|format(dados.total_proventos)|replace(".", ",") }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {# NOVAS SEÇÕES: TOTAIS DO PLANSERV #}
    <div id="planserv-totais" class="tabela-container" style="display: none;">
        <h3>Totais de Proventos e Descontos do Planserv (Período Completo)</h3>
        
        {% if resultados.proventos_totais_planserv %}
            <h4>Proventos que Incidem no Planserv: R$ {{ "%.2f"|format(resultados.proventos_totais_planserv.total)|replace(".", ",") }}</h4>
            {% if resultados.proventos_totais_planserv.detalhes %}
                <p>Detalhes:</p>
                <ul>
                    {% for detalhe in resultados.proventos_totais_planserv.detalhes %}
                        <li>{{ detalhe.descricao }} ({{ detalhe.codigo }}): R$ {{ "%.2f"|format(detalhe.valor)|replace(".", ",") }}</li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>Nenhuma rubrica de provento do Planserv encontrada no período.</p>
            {% endif %}
        {% else %}
            <p>Informações de proventos do Planserv não disponíveis.</p>
        {% endif %}

        <hr>

        {% if resultados.descontos_totais_planserv %}
            <h4>Descontos do Planserv: R$ {{ "%.2f"|format(resultados.descontos_totais_planserv.total)|replace(".", ",") }}</h4>
            {% if resultados.descontos_totais_planserv.detalhes %}
                <p>Detalhes:</p>
                <ul>
                    {% for detalhe in resultados.descontos_totais_planserv.detalhes %}
                        <li>{{ detalhe.descricao }} ({{ detalhe.codigo }}): R$ {{ "%.2f"|format(detalhe.valor)|replace(".", ",") }}</li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>Nenhuma rubrica de desconto do Planserv encontrada no período.</p>
            {% endif %}
        {% else %}
            <p>Informações de descontos do Planserv não disponíveis.</p>
        {% endif %}
    </div>

    {% else %}
    <div class="alert alert-warning">
        Nenhum resultado disponível para exibição. Por favor, envie um arquivo primeiro.
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Alternar entre proventos e descontos
    const buttons = document.querySelectorAll('[data-tipo]');
    buttons.forEach(btn => {
        btn.addEventListener('click', function() {
            buttons.forEach(b => b.classList.remove('active', 'btn-primary'));
            buttons.forEach(b => b.classList.add('btn-secondary'));
            
            this.classList.add('active', 'btn-primary');
            this.classList.remove('btn-secondary');
            
            document.querySelectorAll('.tabela-container').forEach(t => {
                t.style.display = 'none';
            });
            
            document.getElementById(`${this.dataset.tipo}`).style.display = 'block';
        });
    });

    // Ativar o primeiro botão por padrão ao carregar a página
    if (buttons.length > 0) {
        buttons[0].click(); // Simula um clique no primeiro botão ao carregar a página
    }
});
</script>
{% endblock %}
