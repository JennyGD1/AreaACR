{% extends "base.html" %}

{% block title %}Análise Detalhada{% endblock %}
{% block body_class %}page-analise{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/analise.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    <h1>Análise Detalhada</h1>

    <div id="painelControle">
        <h2>Filtros</h2>
        <div class="filtros-container">
            <div class="filtro-item">
                <label for="filtroAno">Ano:</label>
                <select id="filtroAno">
                    <option value="todos">Todos</option>
                    {% for ano in anos_disponiveis %}
                    <option value="{{ ano }}">{{ ano }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filtro-item">
                <label for="filtroRubrica">Rubrica:</label>
                <select id="filtroRubrica">
                    <option value="todos">Todas</option>
                    {% for codigo, descricao in rubricas_detalhadas.items() %}
                    <option value="{{ codigo }}">{{ descricao }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <div class="tabela-container">
        <table class="tabela-analise">
            <thead>
                <tr>
                    <th>RUBRICA</th>
                    <th>DESCRIÇÃO</th>
                    <th>VALOR</th>
                </tr>
            </thead>
            <tbody>
                {% for codigo, valor in resultados.items() %}
                <tr>
                    <td>{{ codigo }}</td>
                    <td>{{ rubricas_detalhadas.get(codigo, 'Descrição não disponível') }}</td>
                    <td>{{ "R$ {:,.2f}".format(valor).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="btn-container">
        <a href="{{ url_for('calculadora') }}" class="btn btn-primary">
            <i class="fas fa-arrow-left"></i> Voltar
        </a>
        <button onclick="exportarParaExcel()" class="btn btn-success">
            <i class="fas fa-file-excel"></i> Exportar para Excel
        </button>
    </div>
</div>

<script>
function exportarParaExcel() {
    // Implementação simplificada da exportação
    let csv = 'Rubrica,Descrição,Valor\n';
    document.querySelectorAll('.tabela-analise tbody tr').forEach(row => {
        const cols = row.querySelectorAll('td');
        csv += `"${cols[0].textContent}","${cols[1].textContent}","${cols[2].textContent}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'analise_contracheques.csv';
    link.click();
}

// Filtros
document.getElementById('filtroAno').addEventListener('change', filtrarTabela);
document.getElementById('filtroRubrica').addEventListener('change', filtrarTabela);

function filtrarTabela() {
    const filtroAno = document.getElementById('filtroAno').value.toLowerCase();
    const filtroRubrica = document.getElementById('filtroRubrica').value.toLowerCase();
    
    document.querySelectorAll('.tabela-analise tbody tr').forEach(row => {
        const cols = row.querySelectorAll('td');
        const anoCol = cols[0].textContent.split('/')[1] || '';
        const rubricaCol = cols[0].textContent.toLowerCase();
        const descricaoCol = cols[1].textContent.toLowerCase();
        
        const matchAno = (filtroAno === 'todos' || anoCol.includes(filtroAno));
        const matchRubrica = (filtroRubrica === 'todos' || 
                             rubricaCol.includes(filtroRubrica) || 
                             descricaoCol.includes(filtroRubrica));
        
        row.style.display = (matchAno && matchRubrica) ? '' : 'none';
    });
}
</script>
{% endblock %}
