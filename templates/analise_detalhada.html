<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ”¬ AnÃ¡lise AvanÃ§ada de Descontos</title>
    <link rel="icon" href="{{ url_for('static', filename='img/logo_maida.png') }}" />
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/navbar.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/analise.css') }}">
</head>
<body class="page-analise">
    {% include 'components/_preloader.html' %}
    {% include 'components/_navbar.html' %}

    <div class="scrollbar-container">
        <div class="scrollbar-thumb" id="scrollThumb"></div>
    </div>
    
    <div class="container">
        <h1>ðŸ”¬ Tabela Geral de Descontos</h1>
        <p>Use os filtros abaixo para refinar a visualizaÃ§Ã£o dos descontos por competÃªncia.</p>
        
        <div id="painelControle">
            <div class="filtros-container">
                <div class="filtro-item">
                    <label for="filtroAno">Filtrar por Ano:</label>
                    <select id="filtroAno">
                        <option value="todos">Todos os Anos</option>
                        {% for ano in anos_ordenados %}
                            <option value="{{ ano }}">{{ ano }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filtro-item">
                    <label for="filtroDesconto">Filtrar por Desconto:</label>
                    <select id="filtroDesconto">
                        <option value="todos">Todos os Descontos</option>
                         {% for chave in colunas_ordenadas %}
                            <option value="{{ chave }}">{{ descricao_rubricas.get(chave, chave|replace('_', ' ')|title) }}</option>
                         {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        
        <div id="resultadoContainer">
            <!-- As tabelas geradas aparecerÃ£o aqui -->
        </div>
    </div>
    
    {% include 'components/_footer.html' %}

    <script src="{{ url_for('static', filename='js/main.js') }}" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DADOS VINDOS DO BACKEND (PYTHON)
            const todasCompetencias = {{ todas_competencias|tojson|safe }};
            const colunasOrdenadasOriginal = {{ colunas_ordenadas|tojson|safe }};
            const descricaoRubricas = {{ descricao_rubricas|tojson|safe }};
            const mesesMap = { "Janeiro": "01", "Fevereiro": "02", "MarÃ§o": "03", "Abril": "04", "Maio": "05", "Junho": "06", "Julho": "07", "Agosto": "08", "Setembro": "09", "Outubro": "10", "Novembro": "11", "Dezembro": "12" };

            // ELEMENTOS DO DOM
            const resultadoContainer = document.getElementById('resultadoContainer');
            const filtroAno = document.getElementById('filtroAno');
            const filtroDesconto = document.getElementById('filtroDesconto');

            // --- FUNÃ‡Ã•ES AUXILIARES ---
            function formatarMoeda(valor) {
                return (valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            }

            function formatarData(competencia) {
                const [mesNome, ano] = competencia.split('/');
                return `${mesesMap[mesNome] || '??'}/${ano}`;
            }

            // --- FUNÃ‡ÃƒO PRINCIPAL PARA GERAR A TABELA ---
            function gerarTabela() {
                const anoSelecionado = filtroAno.value;
                const descontoSelecionado = filtroDesconto.value;

                resultadoContainer.innerHTML = '';

                // 1. Filtrar os dados de acordo com o ano selecionado
                const competenciasFiltradas = todasCompetencias.filter(comp => {
                    if (anoSelecionado === 'todos') return true;
                    return comp.competencia.endsWith(anoSelecionado);
                });

                if (competenciasFiltradas.length === 0) {
                    resultadoContainer.innerHTML = '<p class="aviso">Nenhum dado encontrado para o ano selecionado.</p>';
                    return;
                }

                // 2. Determinar as colunas a serem exibidas
                let colunasParaExibir;
                if (descontoSelecionado === 'todos') {
                    // Mostra apenas as colunas que tÃªm algum valor no perÃ­odo filtrado
                    colunasParaExibir = colunasOrdenadasOriginal.filter(chave => 
                        competenciasFiltradas.some(comp => comp[chave] > 0)
                    );
                } else {
                    colunasParaExibir = [descontoSelecionado];
                }

                if (colunasParaExibir.length === 0) {
                    resultadoContainer.innerHTML = `<p class="aviso">Nenhum valor encontrado para "${descricaoRubricas[descontoSelecionado]}" no perÃ­odo selecionado.</p>`;
                    return;
                }
                
                // 3. Construir a tabela
                const tabela = document.createElement('table');
                tabela.className = 'tabela-analise';
                
                let headerHtml = '<thead><tr><th>MÃªs/Ano</th>';
                colunasParaExibir.forEach(chave => {
                    headerHtml += `<th>${descricaoRubricas[chave] || chave}</th>`;
                });
                headerHtml += '</tr></thead>';
                tabela.innerHTML = headerHtml;

                const tbody = document.createElement('tbody');
                competenciasFiltradas.forEach(comp => {
                    const row = tbody.insertRow();
                    row.insertCell(0).textContent = formatarData(comp.competencia);
                    
                    colunasParaExibir.forEach(chave => {
                        const cell = row.insertCell(-1);
                        cell.textContent = formatarMoeda(comp[chave]);
                    });
                });

                tabela.appendChild(tbody);
                resultadoContainer.appendChild(tabela);
            }

            // --- EVENT LISTENERS ---
            // Adiciona os listeners para os filtros mudarem a tabela dinamicamente
            filtroAno.addEventListener('change', gerarTabela);
            filtroDesconto.addEventListener('change', gerarTabela);

            // Gera a tabela inicial com todos os dados assim que a pÃ¡gina carrega
            gerarTabela();
        });
    </script>
</body>
</html>
