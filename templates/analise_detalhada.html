<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî¨ An√°lise Avan√ßada de Descontos</title>
    <link rel="icon" href="{{ url_for('static', filename='img/logo_maida.png') }}" />
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/navbar.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/analise.css') }}">
</head>
<body class="page-analise">
    {% include 'components/_preloader.html' %}
    {% include 'components/_navbar.html' %}

    <div class="scrollbar-container">
        <div class="scrollbar-thumb" id="scrollThumb"></div>
    </div>
    
    <div class="container">
        <h1>üî¨ An√°lise Avan√ßada de Descontos</h1>
        <p>Use os filtros abaixo e clique em "Gerar Relat√≥rio" para visualizar os dados detalhados.</p>
        
        <!-- PAINEL DE CONTROLE COM FILTROS -->
        <div id="painelControle">
            <h2>Filtros</h2>
            <div class="filtros-container">
                <div class="filtro-item">
                    <label for="filtroAno">Filtrar por Ano:</label>
                    <select id="filtroAno">
                        <option value="todos">Todos os Anos</option>
                        {% for ano in anos_ordenados %}
                            <option value="{{ ano }}">{{ ano }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filtro-item">
                    <label for="filtroDesconto">Filtrar por Desconto:</label>
                    <select id="filtroDesconto">
                        <option value="todos">Todos os Descontos</option>
                         {% for chave in colunas_ordenadas %}
                            <option value="{{ chave }}">{{ descricao_rubricas.get(chave, chave|replace('_', ' ')|title) }}</option>
                         {% endfor %}
                    </select>
                </div>
            </div>
            <div class="btn-container">
                <button id="btnGerarRelatorio" class="btn btn-success">Gerar Relat√≥rio</button>
            </div>
        </div>
        
        <div id="resultadoContainer">
            <!-- As tabelas geradas aparecer√£o aqui -->
        </div>
    </div>
    
    {% include 'components/_footer.html' %}
    <script src="{{ url_for('static', filename='js/main.js') }}" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DADOS VINDOS DO BACKEND
            const todasCompetencias = {{ todas_competencias|tojson }};
            const colunasOrdenadas = {{ colunas_ordenadas|tojson }};
            const descricaoRubricas = {{ descricao_rubricas|tojson }};

            // ELEMENTOS DO DOM
            const btnGerarRelatorio = document.getElementById('btnGerarRelatorio');
            const filtroAno = document.getElementById('filtroAno');
            const filtroDesconto = document.getElementById('filtroDesconto');
            const resultadoContainer = document.getElementById('resultadoContainer');

            function formatarMoeda(valor) {
                return (valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            }

            function gerarTabelaFiltrada() {
                const anoSelecionado = filtroAno.value;
                const descontoSelecionado = filtroDesconto.value;

                resultadoContainer.innerHTML = '';

                // 1. Filtrar os dados de acordo com o ano
                const competenciasFiltradas = todasCompetencias.filter(comp => {
                    if (anoSelecionado === 'todos') return true;
                    return comp.competencia.endsWith(anoSelecionado);
                });

                if (competenciasFiltradas.length === 0) {
                    resultadoContainer.innerHTML = '<p>Nenhum dado encontrado para o ano selecionado.</p>';
                    return;
                }

                // 2. Determinar as colunas a serem exibidas
                let colunasParaExibir = [];
                if (descontoSelecionado === 'todos') {
                    colunasParaExibir = colunasOrdenadas.filter(chave => 
                        competenciasFiltradas.some(comp => comp[chave] > 0)
                    );
                } else {
                    colunasParaExibir = [descontoSelecionado];
                }

                if (colunasParaExibir.length === 0 && descontoSelecionado !== 'todos') {
                     resultadoContainer.innerHTML = `<p>Nenhum valor encontrado para "${descricaoRubricas[descontoSelecionado]}" no per√≠odo selecionado.</p>`;
                    return;
                }

                // 3. Construir a tabela
                const tabela = document.createElement('table');
                tabela.className = 'tabela-analise';
                
                let headerHtml = '<thead><tr><th>M√™s/Ano</th>';
                colunasParaExibir.forEach(chave => {
                    headerHtml += `<th>${descricaoRubricas[chave] || chave}</th>`;
                });
                headerHtml += '</tr></thead>';
                tabela.innerHTML = headerHtml;

                const tbody = document.createElement('tbody');
                competenciasFiltradas.forEach(comp => {
                    const row = tbody.insertRow();
                    row.insertCell(0).textContent = comp.competencia.replace(/([A-Za-z]+)\/(\d{4})/, (match, p1, p2) => `${mesesMap[p1]}/${p2}`);
                    
                    colunasParaExibir.forEach(chave => {
                        row.insertCell(-1).textContent = formatarMoeda(comp[chave]);
                    });
                });

                tabela.appendChild(tbody);
                resultadoContainer.appendChild(tabela);
            }

            // EVENT LISTENER
            btnGerarRelatorio.addEventListener('click', gerarTabelaFiltrada);
        });
    </script>
</body>
</html>
